var app=angular.module("autocomplete",[]),icerinkApp;app.directive("autocomplete",function(){var n=-1;return{restrict:"E",scope:{searchParam:"=ngModel",suggestions:"=data",onType:"=onType",onSelect:"=onSelect",autocompleteRequired:"="},controller:["$scope",function(n){n.selectedIndex=-1;n.initLock=!0;n.setIndex=function(t){n.selectedIndex=parseInt(t)};this.setIndex=function(t){n.setIndex(t);n.$apply()};n.getIndex=function(){return n.selectedIndex};var t=!0;n.completing=!1;n.$watch("searchParam",function(i,r){if(r!==i&&(r||!n.initLock)&&(t&&typeof n.searchParam!="undefined"&&n.searchParam!==null&&(n.completing=!0,n.searchFilter=n.searchParam,n.selectedIndex=-1),n.onType))n.onType(n.searchParam)});this.preSelect=function(){t=!1;n.$apply();t=!0};n.preSelect=this.preSelect;this.preSelectOff=function(){t=!0};n.preSelectOff=this.preSelectOff;n.select=function(i){if(i&&(n.searchParam=i,n.searchFilter=i,n.onSelect))n.onSelect(i);t=!1;n.completing=!1;setTimeout(function(){t=!0},1e3);n.setIndex(-1)}}],link:function(t,i,r){var e,f,u;setTimeout(function(){t.initLock=!1;t.$apply()},250);e="";t.attrs={placeholder:"start typing...","class":"",id:"",inputclass:"",inputid:""};for(f in r)e=f.replace("attr","").toLowerCase(),f.indexOf("attr")===0&&(t.attrs[e]=r[f]);r.clickActivation&&(i[0].onclick=function(){t.searchParam||setTimeout(function(){t.completing=!0;t.$apply()},200)});u={left:37,up:38,right:39,down:40,enter:13,esc:27,tab:9};document.addEventListener("keydown",function(n){var i=n.keyCode||n.which;switch(i){case u.esc:t.select();t.setIndex(-1);t.$apply();n.preventDefault()}},!0);document.addEventListener("blur",function(){setTimeout(function(){t.select();t.setIndex(-1);t.$apply()},150)},!0);i[0].addEventListener("keydown",function(i){var f=i.keyCode||i.which,r=angular.element(this).find("li").length;if(t.completing&&r!=0)switch(f){case u.up:if(n=t.getIndex()-1,n<-1)n=r-1;else if(n>=r){n=-1;t.setIndex(n);t.preSelectOff();break}t.setIndex(n);n!==-1&&t.preSelect(angular.element(angular.element(this).find("li")[n]).text());t.$apply();break;case u.down:if(n=t.getIndex()+1,n<-1)n=r-1;else if(n>=r){n=-1;t.setIndex(n);t.preSelectOff();t.$apply();break}t.setIndex(n);n!==-1&&t.preSelect(angular.element(angular.element(this).find("li")[n]).text());break;case u.left:break;case u.right:case u.enter:case u.tab:n=t.getIndex();n!==-1?(t.select(angular.element(angular.element(this).find("li")[n]).text()),f==u.enter&&i.preventDefault()):f==u.enter&&t.select();t.setIndex(-1);t.$apply();break;case u.esc:t.select();t.setIndex(-1);t.$apply();i.preventDefault();break;default:return}})},template:'        <div class="autocomplete {{ attrs.class }}" id="{{ attrs.id }}">          <input            type="text"            ng-model="searchParam"            placeholder="{{ attrs.placeholder }}"            class="{{ attrs.inputclass }}"            id="{{ attrs.inputid }}"            ng-required="{{ autocompleteRequired }}" />          <ul ng-show="completing && (suggestions | filter:searchFilter).length > 0">            <li              suggestion              ng-repeat="suggestion in suggestions | filter:searchFilter | orderBy:\'toString()\' track by $index"              index="{{ $index }}"              val="{{ suggestion }}"              ng-class="{ active: ($index === selectedIndex) }"              ng-click="select(suggestion)"              ng-bind-html="suggestion | highlight:searchParam"><\/li>          <\/ul>        <\/div>'}});app.filter("highlight",["$sce",function(n){return function(t,i){if(typeof t=="function")return"";if(i){var r="("+i.split(/\ /).join(" |")+"|"+i.split(/\ /).join("|")+")",u=new RegExp(r,"gi");r.length&&(t=t.replace(u,'<span class="highlight">$1<\/span>'))}return n.trustAsHtml(t)}}]);app.directive("suggestion",function(){return{restrict:"A",require:"^autocomplete",link:function(n,t,i,r){t.bind("mouseenter",function(){r.preSelect(i.val);r.setIndex(i.index)});t.bind("mouseleave",function(){r.preSelectOff()})}}});icerinkApp=angular.module("icerinkApp",["ngRoute","firebase","autocomplete"]);icerinkApp.config(["$routeProvider","$locationProvider",function(n){n.when("/Welcome",{templateUrl:"views/welcome.html",controller:"WelcomeController"}).when("/Game",{templateUrl:"views/game.html",controller:"IcerinkController"}).when("/Editor",{templateUrl:"views/pathEditor.html",controller:"pathEditorController"}).otherwise({redirectTo:"/Welcome"})}]);icerinkApp.run(["$rootScope","$location",function(n,t){t.$$path=="/Game"&&n.$on("$routeChangeStart",function(){(n.fireUser===null||n.fireUser===undefined)&&t.path("/Welcome")})}]);icerinkApp.constant("Config",{APP_NAME:"IMPERO SNOW THROW",APP_VERSION:"1.0.0",GOOGLE_ANALYTICS_ID:"",BASE_URL:"",SYSTEM_LANGUAGE:""});icerinkApp.constant("DbConfig",{FIREBASE_URL:"https://shining-fire-3444.firebaseio.com/people",GROUPS:[{id:0,title:"Impero"},{id:1,title:"Pernod Ricard Winemakers Team 1"},{id:2,title:"Pernod Ricard Winemakers Team 2"},{id:3,title:"Domeq Bodegas San Sebastian"},{id:4,title:"Pernod Ricard Travel Retail EU"},{id:5,title:"Beefeater"},{id:6,title:"Lindt UK"},]});icerinkApp.constant("GameConfig",{snowballAudioHitWindow:"theme/icerink/fx/snowballHitWindow.mp3",charImg:"theme/icerink/img/char/[NAME].png",charImgBig:"theme/icerink/img/charBig/[NAME]b.jpg",maxPlayer:20,minPlayer:1,hideWhenHit:400,respawnAfterHit:6e3,skaterAudioSlip:"theme/icerink/fx/slideDown.mp3",maxSpeed:9,minSpeed:7,hitPoint:10,getHitPoint:-5,snowballStartPoint:[552,200],snowballCurve:100,snowballSpeed:500,snowballFadeout:100,snowballAudioHit:"theme/icerink/fx/snowballHit.mp3",snowEffect:!1,snowFlakeRound:!0,snowFlakeMinSize:2,snowFlakeMaxSize:3,snowFlakeMaxSpeed:3,snowFlakeMCount:100,parallaxEffect:!0,mountainSpeedBack:.02,mountainSpeedFront:.01,fakeLoginOn:!1,fakeLoginName:"Pedro Usuriaga"});icerinkApp.value("AppOwner",{name:"Sener Koc",company:"lifetoweb",mail:"sener@lifetoweb.com"});icerinkApp.controller("WelcomeController",["$scope","$rootScope","$location","$filter","$timeout","fireManager","$firebaseObject","$firebaseArray","DbConfig","GameConfig",function(n,t,i,r,u,f,e,o,s,h){var l=new Audio(h.snowballAudioHitWindow),c;n.characterLook="";c=document.getElementById("gameBgContainer");n.showDialog=!1;n.intro1=!0;n.intro2=!1;n.login1=!1;n.login2=!1;n.loginGroup=!1;n.loading=!1;n.showLogo=!0;n.startAnimation=function(){u(function(){var t=document.getElementById("snowballBig");t.className=t.className+" sbAnim";u(function(){l.play();c.className=c.className+" blur";document.getElementById("appContainer").className="shakeAnim";n.showDialog=!0;t.className=t.className.replace(" sbAnim","")},500)},100)};n.btnCommence=function(){n.intro1=!1;n.intro2=!0};n.btnNext=function(){n.intro2=!1;n.showLogo=!1;n.loading=!0;var t=new f(e,o,s.FIREBASE_URL).getAll();t.$loaded().then(function(){n.loading=!1;n.people=t;n.peopleNames=[];for(var i=0;i<n.people.length;i++)n.peopleNames[i]=n.people[i].name+" | "+n.people[i].company[0];document.getElementById("autoCompleteUser").setAttribute("autocomplete","off");n.login1=!0})};n.onLoginClick=function(){var i,u;h.fakeLoginOn&&(n.txtUserName=h.fakeLoginName);n.txtUserName!=null&&n.txtUserName.length>0&&(i=r("filter")(n.people,{name:n.txtUserName.substr(0,n.txtUserName.indexOf("|")-1)}),i!==null&&i.length>0&&(u=new f(e,o,s.FIREBASE_URL+"/"+i[0].$id).getUser(),u.$loaded().then(function(){u.$bindTo(t,"fireUser").then(function(){console.log("logged in: "+t.fireUser.id+": "+t.fireUser.name);n.login1=!1;console.log("Group : "+t.fireUser.group.length);t.fireUser.group.length>1?(n.userGroups=t.fireUser.group,n.loginGroup=!0,n.groupList=s.GROUPS):(n.groupSelectedId=t.fireUser.group[0],n.showCaracter(),t.groupSelectedId=n.groupSelectedId)})})))};n.onGroupChange=function(){n.loginGroup=!1;n.showCaracter();t.groupSelectedId=n.groupSelectedId};n.showCaracter=function(){n.login2=!0;n.characterLook=n.getCharImg(t.fireUser.id)};n.btnStartGame=function(){c.className=c.className.replace(" blur","");t.fireGroupPlayers=r("filter")(n.people,{name:"!"+t.fireUser.name});t.fireGroupPlayers=r("hasItems")(t.fireGroupPlayers,[n.groupSelectedId],"group");t.fireGroupPlayers.sort(function(){return.5-Math.random()});t.fireGroupPlayers=r("limitTo")(t.fireGroupPlayers,h.maxPlayer);i.path("/Game")};n.getCharImg=function(n){return n=n+"",h.charImgBig.replace("[NAME]",n.toLowerCase()).replace(/ /g,"")}}]);icerinkApp.filter("inArray",function(n){return function(t,i,r){if(i)return n("filter")(t,function(n){return i.indexOf(n[r])!=-1})}});icerinkApp.filter("hasItems",function(){return function(n,t,i){return n.filter(function(n){for(var r in n[i])if(t.indexOf(n[i][r])!=-1)return!0;return!1})}});app.directive("aSubmit",function(){return function(n,t,i){t.bind("keydown keypress",function(t){t.which===13&&(n.$apply(function(){n.$eval(i.aSubmit)}),t.preventDefault())})}});icerinkApp.factory("fireManager",["$firebaseObject","$firebaseArray",function(n){function t(n,t,i){this.$firebaseObject=n;this.$firebaseArray=t;this.ref=new Firebase(i)}return t.prototype.getAll=function(){return this.$firebaseArray(this.ref)},t.prototype.getUser=function(){return n(this.ref)},t}]);icerinkApp.factory("prefixService",function(){return{prefix:function(){var n=window.getComputedStyle(document.documentElement,""),t=(Array.prototype.slice.call(n).join("").match(/-(moz|webkit|ms)-/)||n.OLink===""&&["","o"])[1],i="WebKit|Moz|MS|O".match(new RegExp("("+t+")","i"))[1];return"-"+t+"-"}}});icerinkApp.factory("snowEffect",["GameConfig",function(n){return{start:function(){snowFall.snow(document.getElementsByTagName("body"),{round:n.snowFlakeRound,minSize:n.snowFlakeMinSize,maxSize:n.snowFlakeMaxSize,maxSpeed:n.snowFlakeMaxSpeed,flakeCount:n.snowFlakeMCount})}}}]);icerinkApp.factory("parallaxEffect",["GameConfig",function(n){return{start:function(){function e(n){return t=r?event.clientX+document.body.scrollLeft:n.pageX,t<0&&(t=0),o(t),!0}function o(n){for(var r,t=0;t<i.length;t++)r=i[t][1]-i[t][2]*(.5*window.innerWidth-n),i[t][0].style.marginLeft=r+"px"}var r=document.all?!0:!1;r||document.captureEvents(Event.MOUSEMOVE);document.onmousemove=e;var t=0,u=document.getElementById("mountain1"),f=document.getElementById("mountain2"),i=[[u,-666.5,n.mountainSpeedBack],[f,-666.5,n.mountainSpeedFront]]}}}]);icerinkApp.controller("IcerinkController",["$scope","$document","$rootScope","$http","$filter","$q","$log","prefixService","snowEffect","parallaxEffect","$timeout","fireManager","$firebaseObject","$firebaseArray","DbConfig","GameConfig",function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){function tt(){var t=new l(a,v,y.FIREBASE_URL).getAll();t.$loaded().then(function(){n.leaderboard=t;n.leaderboard=u("hasItems")(n.leaderboard,[i.groupSelectedId],"group")})}var d,w,b,k;n.userIndex=i.fireUser.$id;n.userName=i.fireUser.name;n.userCharacter=i.fireUser.character;n.leaderboard=null;var g=["killing it!","nice one!","doing well!","keep it up!","ho-ho-ho-ooold up!","gonna be a good xmas!","its a blizzard!"],nt=["you are losing it","you can do better","oh (rein)dear","try harder!","you suck, santa!","you throw #likeagirl"];n.$watchCollection("leaderboard",function(){console.log("rank changed + uRank-"+i.fireUser.$id);oldRank=n.currentRank;n.currentRank=t.find("#uRank-"+i.fireUser.$id).innerText;oldRank<n.currentRank&&n.currentRank<=7?n.notifications.push(g[n.currentRank-1]):n.notifications.push(nt[n.currentRank-1]);console.log("changed..")});tt();n.currentHit=[];n.currentHitBy=[];n.notifications=[];n.modalOverlay=!1;n.scoreModal=!1;n.howToPlayModal=!1;n.skaters=i.fireGroupPlayers;n.score=i.fireUser.score;n.hitpoint=p.hitPoint;n.getHitPoint=p.getHitPoint;d=o.prefix();p.snowEffect&&s.start();p.parallaxEffect&&h.start();w=document.getElementById("gameBgContainer");b=document.getElementById("gameLayout");w.className=w.className.replace(" blur","");b.className=b.className.replace(" blur","");k=!0;n.$watch("$root.fireUser",function(){k||(n.notifications.push(["hitByNotification",p.getHitPoint,i.fireUser.get_hit_by+" hit you"]),n.score=i.fireUser.score);k=!1});r({method:"GET",url:"data/paths.json",cache:!1}).then(function(t){n.paths=t.data;for(var e=d3.select("#gameArea"),o=d3.select("#skaters"),i=0,i=0;i<n.skaters.length;i++){var r="char"+n.skaters[i].id,u=r+"Path",s=n.paths[i],f="background-image:url("+n.getCharImg(""+n.skaters[i].id)+"); ",h=o.insert("div",":first-child").attr("class","skaters").attr("id",r).attr("data-index",n.skaters[i].$id).attr("data-hit","false").attr("style",f).html('<span class="skaterName gothamBlack">'+n.skaters[i].name+"<\/span>"),c=e.append("path").data([s]).attr("d",d3.svg.line().tension(0).interpolate("cardinal-closed")).attr("id",u);n.transitions(d3.select("#"+u),d3.select("#"+r),f)}},function(n){e.error(n)});n.hitSomeone=function(t){i.fireUser.hit_count+=1;i.fireUser.score+=p.hitPoint;n.score=i.fireUser.score;var r=new l(a,v,y.FIREBASE_URL+"/"+t).getUser();r.$loaded().then(function(){n.notifications.push(["hitNotification","+"+n.hitpoint,"hit "+r.name]);r.score+=p.getHitPoint;r.get_hit_count+=1;r.get_hit_by=i.fireUser.name;r.$save()})};n.transitions=function(t,i,r){i.transition().duration(n.calcDuration(t.node().getTotalLength())).ease("none").attrTween("style",n.translateAlong(t.node(),r)).each("end",function(){n.transitions(t,i,r)})};n.getCharImg=function(n){return p.charImg.replace("[NAME]",n.toLowerCase()).replace(/ /g,"")};n.calcDuration=function(n){return~~(n*(Math.floor(Math.random()*(p.maxSpeed-p.minSpeed))+p.minSpeed))};n.translateAlong=function(n,t){var i=0,r=0,u=n.getTotalLength();return function(){return function(f){var e=n.getPointAtLength(f*u),o=1,s;return o=i<e.x?-1:1,i=e.x,s=1,r<e.y,r=e.y,d+"transform:scaleX("+o+") !important; "+t+" z-index:"+~~[e.y]+";top:"+e.y+"px;left:"+e.x+"px;"}}};n.respawn=function(t){var i="background-image:url("+n.getCharImg(t.replace("char",""))+"); ";n.transitions(d3.select("#"+t+"Path"),d3.select("#"+t),i);c(function(){document.getElementById(t).className=document.getElementById(t).className.replace(" respawned","")},1200)};n.OpenScoreBoard=function(){n.modalOverlay=!0;w.className=w.className+" blur";b.className=b.className+" blur";n.scoreModal=!0};n.getRowClass=function(n){return n.name===i.fireUser.name?"currentUser":"normal"};n.OpenHowToPlay=function(){w.className=w.className+" blur";b.className=b.className+" blur";n.modalOverlay=!0;n.howToPlayModal=!0};n.closeModal=function(){w.className=w.className.replace(" blur","");b.className=b.className.replace(" blur","");n.howToPlayModal=!1;n.scoreModal=!1;n.modalOverlay=!1}}]);icerinkApp.controller("SnowballController",["$scope","$rootScope","$log","Snowball","prefixService","$timeout","GameConfig",function(n,t,i,r,u,f,e){var s=new Audio(e.snowballAudioHit),h=new Audio(e.skaterAudioSlip),c=u.prefix(),o;n.showSnowball=!1;n.readyFire=!0;o=document.getElementById("svgHitContainer");n.drawPath=function(t){if(n.readyFire){n.readyFire=!1;o.className=o.className+" locked";n.getMousePosition=function(n){n=n||window.event;var i=n.target||n.srcElement,t=i.getBoundingClientRect(),r=n.clientX-t.left,u=n.clientY-t.top;return[r,u]};n.snowpath=r.getPath(e.snowballStartPoint,n.getMousePosition(t));n.direction="";n.getMousePosition(t)[0]>e.snowballStartPoint[0]&&(n.direction="-");n.showSnowball=!0;var l=document.getElementById("snowballPath"),i=d3.select("#snowball"),u=document.getElementsByClassName("skaters");i.style("opacity","1");i.classed("impact",!1);function a(t){return function(){return function(i){var f=t.getPointAtLength(i*t.getTotalLength()),r=.2,u;return 1-i>.2&&(r=1-i),u=0,u<360&&(u=(r*100+r)*2.1),c+"transform: translate("+f.x+"px,"+f.y+"px) scale("+r+") rotate("+n.direction+u+"deg)"}}}i.transition().duration(e.snowballSpeed).ease("none").attrTween("style",a(l)).each("end",function(){var l,r,c;for(i.classed("impact",!0),f(function(){i.style("opacity","0")},e.snowballFadeout),s.play(),l=0;l<u.length;l++)if(r=u[l],n.getMousePosition(t)[0]>r.offsetLeft&&n.getMousePosition(t)[0]<r.offsetLeft+r.offsetWidth&&n.getMousePosition(t)[1]>r.offsetTop&&n.getMousePosition(t)[1]<r.offsetTop+r.offsetHeight){d3.selectAll("#"+r.id).transition().duration(0);c=document.getElementById(r.id);h.play();n.hitSomeone(c.getAttribute("data-index"));c.className="fallingSkater";f(function(){c.className=c.className+" fall1";f(function(){c.className=c.className+" hide";f(function(){c.className="skaters respawned";n.respawn(r.id)},e.respawnAfterHit)},e.hideWhenHit)},200);break}n.readyFire=!0;o.className=o.className.replace(" locked","")})}}}]);icerinkApp.factory("Snowball",["GameConfig",function(n){return{getPath:function(t,i){var r=0,u,f;return r=t[0]>i[0]?t[0]-(t[0]-i[0])/2:t[0]+(i[0]-t[0])/2,u=i[1]-n.snowballCurve,f=[r,u],"M "+t[0]+","+t[1]+" Q "+r+","+u+" "+i[0]+","+i[1]}}}]);